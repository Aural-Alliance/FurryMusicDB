#!/usr/bin/env php
<?php

declare(strict_types=1);

use Doctrine\DBAL\DriverManager;

error_reporting(E_ALL & ~E_NOTICE & ~E_STRICT);
ini_set('display_errors', '1');

require(__DIR__ . '/../vendor/autoload.php');

echo "Starting services...\n";

$_ENV = getenv();

$elapsed = 0;
$timeout = 180;

while ($elapsed <= $timeout) {
    try {
        $parser = new Doctrine\DBAL\Tools\DsnParser([
                'postgres' => 'pdo_pgsql'
        ]);
        $connectionOptions = $parser->parse($_ENV['DATABASE_URL']);

        $conn = DriverManager::getConnection($connectionOptions);
        $conn->getNativeConnection()->exec('SELECT 1');

        echo "Services started up and ready!\n";
        die(0);
    } catch (\Throwable $e) {
        sleep(1);
        $elapsed += 1;

        echo $e->getMessage()."\n";
    }
}

echo "Timed out waiting for services to start.\n";
die(1);
